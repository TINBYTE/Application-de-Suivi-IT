@startuml
!theme plain
title Diagramme de S√©quence - Affectation d'un Ticket √† un Sous-traitant

' Acteurs et participants
actor "RSI" as RSI
participant "TicketDetailView" as VIEW
participant "ContractorService" as CONTRACTOR_SVC
participant "TicketService" as TICKET_SVC
participant "SLAManager" as SLA
participant "EmailService" as EMAIL
participant "TemplateEngine" as TEMPLATE
participant "NotificationService" as NOTIF
participant "Database" as DB
participant "Sous-traitant" as CONTRACTOR

' === PHASE 1: CONSULTATION ET D√âCISION ===
group #LightBlue Consultation du Ticket et D√©cision d'Assignation
    RSI -> VIEW : Consulte d√©tail ticket\n#TICK-2024-0123
    activate VIEW
    
    VIEW -> DB : R√©cup√®re donn√©es ticket complet
    activate DB
    DB -> VIEW : Retourne ticket + probl√®me\n+ historique
    deactivate DB
    
    VIEW -> RSI : Affiche d√©tail ticket
    note right : ‚Ä¢ Statut: NOUVEAU\n‚Ä¢ Priorit√©: √âLEV√âE\n‚Ä¢ Probl√®me: Serveur mail HS\n‚Ä¢ Pas encore assign√©
    
    RSI -> RSI : Analyse technique\ndu probl√®me
    note right : ‚Ä¢ Complexit√©: Expertise messagerie\n‚Ä¢ Urgence: 50 utilisateurs impact√©s\n‚Ä¢ D√©cision: Sous-traitance requise
    
    RSI -> VIEW : Clique "Assigner √† sous-traitant"
    
    VIEW -> CONTRACTOR_SVC : Demande liste\nsous-traitants √©ligibles
    activate CONTRACTOR_SVC
end

' === PHASE 2: S√âLECTION DU SOUS-TRAITANT ===
group #LightGreen S√©lection du Sous-traitant Optimal
    CONTRACTOR_SVC -> DB : Requ√™te sous-traitants actifs\navec expertise messagerie
    activate DB
    DB -> CONTRACTOR_SVC : Retourne liste candidats
    deactivate DB
    
    CONTRACTOR_SVC -> CONTRACTOR_SVC : Filtre par crit√®res
    note right : ‚Ä¢ Sp√©cialit√©: Messagerie\n‚Ä¢ Disponibilit√©: Charge < 80%\n‚Ä¢ Performance: Rating > 4/5\n‚Ä¢ SLA compatible: < 24h r√©solution
    
    CONTRACTOR_SVC -> CONTRACTOR_SVC : Classe par score\n(performance + disponibilit√©)
    
    CONTRACTOR_SVC -> VIEW : Retourne liste tri√©e\nsous-traitants recommand√©s
    deactivate CONTRACTOR_SVC
    
    VIEW -> RSI : Affiche s√©lection avec\nrecommandations
    note right : 1. TechCorp (‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ) - Dispo\n2. MailExpert (‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ) - Charg√©\n3. InfoService (‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ) - Dispo
    
    RSI -> RSI : S√©lectionne TechCorp\n(meilleur score)
    
    RSI -> VIEW : Confirme choix TechCorp
end

' === PHASE 3: CONFIGURATION SLA ET ASSIGNATION ===
group #LightYellow Configuration SLA et Assignation Formelle
    VIEW -> SLA : Calcule SLA pour\nTechCorp + Priorit√© √âLEV√âE
    activate SLA
    
    SLA -> DB : R√©cup√®re contrat SLA TechCorp
    activate DB
    DB -> SLA : Retourne param√®tres SLA
    deactivate DB
    
    SLA -> SLA : Calcule d√©lais selon priorit√©
    note right : Priorit√© √âLEV√âE + TechCorp:\n‚Ä¢ Accus√© r√©ception: 2h\n‚Ä¢ Premi√®re r√©ponse: 4h\n‚Ä¢ R√©solution: 24h
    
    SLA -> SLA : Calcule timestamps deadline
    note right : Cr√©ation: 14:00\n‚Ä¢ Accus√©: 16:00\n‚Ä¢ R√©ponse: 18:00\n‚Ä¢ R√©solution: 14:00+1j
    
    SLA -> VIEW : Retourne d√©lais calcul√©s
    deactivate SLA
    
    VIEW -> TICKET_SVC : Assigne ticket √† TechCorp\navec SLA calcul√©
    activate TICKET_SVC
    
    TICKET_SVC -> DB : Met √† jour ticket
    activate DB
    note right : ‚Ä¢ contractor_id = TechCorp\n‚Ä¢ status = ASSIGNED\n‚Ä¢ assigned_at = NOW()\n‚Ä¢ sla_deadline = calcul√©\n‚Ä¢ assigned_by = RSI
    DB -> TICKET_SVC : Confirme mise √† jour
    deactivate DB
    
    TICKET_SVC -> DB : Cr√©e entr√©e historique
    activate DB
    note right : StatusHistory:\n‚Ä¢ old_status: NEW\n‚Ä¢ new_status: ASSIGNED\n‚Ä¢ reason: "Assign√© √† TechCorp"\n‚Ä¢ changed_by: RSI
    DB -> TICKET_SVC : Confirme historique
    deactivate DB
    deactivate TICKET_SVC
end

' === PHASE 4: PR√âPARATION ET ENVOI EMAIL ===
group #Orange Pr√©paration du Dossier de Transmission
    VIEW -> EMAIL : Pr√©pare email assignation\npour TechCorp
    activate EMAIL
    
    EMAIL -> TEMPLATE : Charge template\n"Assignation Ticket"
    activate TEMPLATE
    TEMPLATE -> EMAIL : Retourne template structure
    deactivate TEMPLATE
    
    EMAIL -> DB : R√©cup√®re donn√©es compl√®tes
    activate DB
    note right : ‚Ä¢ D√©tail ticket complet\n‚Ä¢ Informations probl√®me\n‚Ä¢ Historique communications\n‚Ä¢ Pi√®ces jointes\n‚Ä¢ Contact demandeur
    DB -> EMAIL : Retourne dataset complet
    deactivate DB
    
    EMAIL -> TEMPLATE : Remplit template avec donn√©es
    activate TEMPLATE
    TEMPLATE -> TEMPLATE : G√©n√®re contenu personalis√©
    note right : ‚Ä¢ Objet: [TICKET #TICK-2024-0123] Serveur mail inaccessible\n‚Ä¢ Corps: Infos probl√®me + SLA + contacts\n‚Ä¢ PJ: Captures d'√©cran + logs
    TEMPLATE -> EMAIL : Retourne email finalis√©
    deactivate TEMPLATE
    
    EMAIL -> EMAIL : Valide contenu et PJ\n(taille, format, virus)
end

' === PHASE 5: TRANSMISSION SOUS-TRAITANT ===
group #LightCyan Transmission et Notification
    EMAIL -> CONTRACTOR : Envoie email assignation
    note over CONTRACTOR : üìß **Email re√ßu**\nObjet: [TICKET #TICK-2024-0123]\nServeur mail inaccessible
    
    EMAIL -> DB : Enregistre communication sortante
    activate DB
    note right : Communication:\n‚Ä¢ type: EMAIL\n‚Ä¢ direction: SENT\n‚Ä¢ subject: [TICKET #...]\n‚Ä¢ content: contenu complet\n‚Ä¢ recipient: TechCorp\n‚Ä¢ sent_at: NOW()
    DB -> EMAIL : Confirme enregistrement
    deactivate DB
    
    EMAIL -> NOTIF : D√©clenche notifications internes
    activate NOTIF
    NOTIF -> NOTIF : Programme rappels automatiques
    note right : ‚Ä¢ Si pas d'accus√© dans 2h ‚Üí Relance\n‚Ä¢ Si pas de r√©ponse dans 4h ‚Üí Alerte\n‚Ä¢ Si pas r√©solu dans 24h ‚Üí Escalade
    deactivate NOTIF
    
    EMAIL -> RSI : Confirme envoi r√©ussi
    deactivate EMAIL
    
    VIEW -> RSI : Affiche confirmation assignation
    note right : ‚úì Ticket assign√© √† TechCorp\n‚úì Email envoy√©\n‚úì SLA activ√©: 24h\n‚úì Monitoring d√©marr√©
    deactivate VIEW
end

' === PHASE 6: R√âACTION SOUS-TRAITANT ===
group #Pink R√©ception et Accus√© par le Sous-traitant
    CONTRACTOR -> CONTRACTOR : Re√ßoit et lit email
    note right : ‚Ä¢ Analyse du probl√®me\n‚Ä¢ V√©rification disponibilit√©\n‚Ä¢ Estimation complexit√©
    
    CONTRACTOR -> CONTRACTOR : Prend en charge ticket\ndans son syst√®me interne
    
    CONTRACTOR -> EMAIL : Envoie accus√© de r√©ception
    note right : "Accus√© r√©ception ticket\n#TICK-2024-0123\nPrise en charge confirm√©e\nAnalyse en cours"
    
    EMAIL -> DB : Enregistre communication entrante
    activate DB
    note right : Communication:\n‚Ä¢ type: EMAIL\n‚Ä¢ direction: RECEIVED\n‚Ä¢ subject: RE: [TICKET #...]\n‚Ä¢ content: accus√© r√©ception\n‚Ä¢ sender: TechCorp\n‚Ä¢ received_at: NOW()
    DB -> EMAIL : Confirme enregistrement
    deactivate DB
    
    EMAIL -> TICKET_SVC : Met √† jour statut ticket
    activate TICKET_SVC
    TICKET_SVC -> DB : Change statut ASSIGNED ‚Üí ACKNOWLEDGED
    activate DB
    note right : ‚Ä¢ status = ACKNOWLEDGED\n‚Ä¢ acknowledged_at = NOW()\n‚Ä¢ sla_ack_respected = TRUE
    DB -> TICKET_SVC : Confirme maj statut
    deactivate DB
    deactivate TICKET_SVC
    
    EMAIL -> RSI : Notifie accus√© re√ßu
    note right : üì± Notification:\n"TechCorp a accus√© r√©ception\ndu ticket #TICK-2024-0123"
end

' === PHASE 7: MONITORING AUTOMATIQUE ACTIV√â ===
group #FFCCCC Activation du Monitoring Automatique
    note over NOTIF, SLA #FFAAAA : **üîÑ Monitoring SLA Automatique Activ√©**
    
    NOTIF -> NOTIF : Lance surveillance continue
    note right : ‚Ä¢ Contr√¥le respect d√©lais\n‚Ä¢ Calcul temps restant\n‚Ä¢ Alertes programm√©es\n‚Ä¢ Relances automatiques
    
    SLA -> SLA : D√©marre compteurs SLA
    note right : ‚è±Ô∏è **Compteurs actifs:**\n‚Ä¢ Temps √©coul√©: 45min\n‚Ä¢ Prochaine √©tape: R√©ponse dans 3h15\n‚Ä¢ Deadline r√©solution: 23h15
end

' Messages de statut
note over RSI #LIGHTGREEN : **‚úì Assignation R√©ussie**\n‚Ä¢ Ticket pris en charge par TechCorp\n‚Ä¢ SLA 24h activ√© et surveill√©\n‚Ä¢ Communications trac√©es\n‚Ä¢ Monitoring automatique en cours

note over CONTRACTOR #LIGHTBLUE : **üìã Ticket en Traitement**\n‚Ä¢ Probl√®me analys√©\n‚Ä¢ Ressources allou√©es\n‚Ä¢ Deadline: 24h\n‚Ä¢ Statut: ACKNOWLEDGED

' R√©sultat final
note over RSI, CONTRACTOR #FFFFCC : **üéØ R√©sultat de l'Assignation:**\n‚Ä¢ Ticket formellement assign√© avec SLA appropri√©\n‚Ä¢ Sous-traitant notifi√© et engag√©\n‚Ä¢ Monitoring automatique et relances programm√©es\n‚Ä¢ Tra√ßabilit√© compl√®te des √©changes\n‚Ä¢ RSI inform√© en temps r√©el des √©volutions

@enduml